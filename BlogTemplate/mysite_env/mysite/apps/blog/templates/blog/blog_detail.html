{% extends 'base.html' %}
{% block title %}{{ blog.title }}{% endblock %}
{% block nav_blog_active %}active{% endblock %}

{% load staticfiles %}
{% block head_extends %}
    <link rel="stylesheet" type="text/css" href="{% static 'blog/../../static/blog/blog.css' %}">
        <script type="text/javascript" src="{% static 'js/../../static/js/jquery-1.11.3.min.js' %}"></script>

        <!--emojione v2.1.1 ä½¿ç”¨bootstrapçš„cdn-->
        <link rel="stylesheet" type="text/css" href="http://cdn.bootcss.com/emojione/2.1.1/assets/sprites/emojione.sprites.css">
        <script type="text/javascript" src="http://cdn.bootcss.com/emojione/2.1.1/lib/js/emojione.min.js"></script>

        <!--emojionearea-->
        <link rel="stylesheet" type="text/css" href="{% static 'css/../../static/css/emojionearea-2.1.3.min.css' %}">
        <script type="text/javascript" src="{% static 'js/../../static/js/emojionearea-2.1.3.min.js' %}"></script>
{% endblock %}

{# é¡µé¢å†…å®¹ #}
{% block content %}
    <div class="container">
        <div class="row">
            <div class="col-xs-10 col-md-offset-1">
                    <h3>{{ blog.title }}</h3>
                    <ul class="blog-info-description">
                        <li>ä½œè€…ï¼š{{ blog.author }}</li>
                        <li>å‘è¡¨æ—¥æœŸï¼š{{ blog.created_time|date:"Y-m-d H:i:s" }}</li>
                        <li>åˆ†ç±»ï¼š
                            <a href="{% url 'blogs_with_type' blog.blog_type.pk %}">{{ blog.blog_type }}</a>
                        </li>
                        <li>é˜…è¯»ï¼ˆ{{ blog.get_read_num }}ï¼‰</li>
                    </ul>
                    <div class="blog-content">{{ blog.content|safe }}</div>
                    <div class="blog_more">
                        <p>
                            {% if previous_blog %} {# å¦‚æœæœ‰ä¸Šä¸€ç¯‡ #}
                                <a href="{% url 'blog_detail' previous_blog.pk %}">ä¸Šä¸€ç¯‡ï¼š{{ previous_blog.title }}</a>
                            {% else %} {# æ²¡æœ‰ä¸Šä¸€ç¯‡æç¤ºæ²¡æœ‰ #}
                                æ²¡æœ‰äº†
                            {% endif %}
                        </p>
                        <p>
                            {% if next_blog %}
                                <a href="{% url 'blog_detail' next_blog.pk %}">ä¸‹ä¸€ç¯‡ï¼š{{ next_blog.title }}</a>
                            {% else %}
                                æ²¡æœ‰å’¯
                            {% endif %}
                        </p>
                    </div>
            </div>   
        </div>
        <div class="row">
            <div class="col-xs-10 col-md-offset-1">
                {# è¯„è®ºåŒºåŸŸ #}
                <div class="comment-area">
                    <h3 class="comment-area-title">è¯„è®ºåŒºåŸŸ</h3>
                    {% if user.is_authenticated %}{# å¦‚æœç™»å½• #}
                        {# è¯„è®º #}
                        <form id="comment-form" action="{% url 'update_comment' %}" method="post" style="overflow: hidden;">
                            {% csrf_token %}
                            <div class="form-group">
                                <label for="id_comment">{{ user.username }}ï¼Œæ¬¢è¿ä½ </label>
                                <textarea name="text" id="id_comment" class="form-control comment_content" cols="30" rows="4"></textarea>
                                {# é”™è¯¯æç¤º #}
                                <span id="comment_error" class="text-danger pull-left"></span>
                            </div>
                            {# è·å–ç±»å‹ã€ID#}
                            <input type="hidden" name="content_type" value="blog">
                            <input type="hidden" name="object_id" value="{{ blog.pk }}">
                            <input type="submit" value="æäº¤" class="btn btn-primary" style="float: right;">
                        </form>
                    {% else %} {# å¦‚æœæ²¡æœ‰ç™»å½• #}
                        æ‚¨å°šæœªç™»å½•ï¼Œç™»å½•å³å¯è¯„è®ºï¼Œ
                        <a class="btn btn-primary" href="{% url 'login' %}?from={{ request.get_full_path }}">ç™»å½•</a>
                        <span>or</span>
                        <a class="btn btn-danger" href="{% url 'register' %}?from={{ request.get_full_path }}">æ³¨å†Œ</a>
                    {% endif %}
                </div>
                <div class="comment-area">
                    <h3 class="comment-area-title">è¯„è®ºåˆ—è¡¨</h3>
                    <div id="comment-list" class="reply_content">
                        {% for comment in comments %}
                            <div>
                                {{ comment.comment_user.username }}
                                ï¼ˆ{{ comment.comment_time|date:"Y-m-d H:i:s" }}ï¼‰:{{ comment.context|safe }}
                            <img alt="ğŸ˜" class="emojione">
                            </div>

                        {% empty %}
                            <p>æš‚æ— è¯„è®º</p>
                        {% endfor %}
                    </div>

            </div>
        </div>
    </div>
{% endblock %}
{% block script_extends %}
    {# è¡¨æƒ… #}
    <script type="text/javascript">
        //å¼•å…¥è¡¨æƒ…
        $("#id_comment").emojioneArea();
        //è½¬ä¹‰è¡¨æƒ…
        $(".reply_content").each(function(){
        $(this).html(emojione.toImage($(this).text()));
            });

        {# å¼‚æ­¥æäº¤ #}
        $('#comment-form').submit(function () {
            $('#comment_error').text('');
            $.ajax({
                cache: false,
                url: '{% url 'update_comment' %}',
                type: 'POST',
                data: $('#comment-form').serialize(),//formæ•°æ®ä¼ åˆ°åç«¯
                //æäº¤æˆåŠŸ,æ‰§è¡Œsuccessã€‚dataï¼šåç«¯ä¼ é€’ç»™jsçš„æ•°æ®
                success: function (data) {
                    console.log(data);
                    //ä¼ é€’åç«¯å€¼ç»™ajax,å¹¶ä¸”æ˜¾ç¤ºåœ¨è¯„è®ºåˆ—è¡¨
                    if (data['status'] == 'SUCCESS'){
                        var comment_html = '<div>'+ data['comment_user'] + '(' +  data['comment_time']
                                            + ')' + data['context'] + '</div>';
                        //å»æ‰è¯„è®ºåä¿ç•™çš„å­—
                        var comment_obj=$('.emojionearea-editor');
                        comment_obj.text("");//æŠŠä¿ç•™çš„å­—å˜æˆç©ºæ–‡æœ¬
                        //ä¼ é€’dataç»™è¯„è®ºåˆ—è¡¨
                        $('#comment-list').prepend(comment_html);
                    }else{
                        //ä¼ é€’é”™è¯¯(textæ ·å¼)
                        $('#comment_error').text(data['massage']);
                    }

                },
                //å¦‚æœæœ‰é”™è¯¯
                error: function (xhr) {
                    console.log(xhr);
                }
            });
            return false; //ä¸è®©submitè½¬è·³
        });
    </script>
{% endblock %}